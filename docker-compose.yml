# 이곳에 docker-compose로 실행할 서비스(컨테이너)들을 정의합니다.
services:
  # 'keycloak' 이라는 이름의 서비스를 정의합니다.
  keycloak:
    # 이 서비스가 사용할 Docker 이미지를 지정합니다.
    image: quay.io/keycloak/keycloak:25.0.2
    
    #environment: DB 연결 정보 및 관리자 계정 설정
    environment:
      KC_DB: postgres                   # PostgreSQL 사용
      KC_DB_URL_HOST: keycloak-db       # DB 호스트 이름
      KC_DB_URL_DATABASE: keycloak      # DB 이름
      KC_DB_USERNAME: keycloak          # DB 사용자
      KC_DB_PASSWORD: secret            # DB 비밀번호
      KEYCLOAK_ADMIN: admin             # Keycloak 관리자 이름
      KEYCLOAK_ADMIN_PASSWORD: admin    # Keycloak 관리자 비밀번호

    #DB 컨테이너 먼저 실행
    depends_on:
      - keycloak-db
      
    # 컨테이너가 시작될 때 실행할 명령어를 지정합니다.
    # 'start'는 Keycloak을 시작하는 명령어입니다.
    # --spi-* 옵션은 개발용: 정적 파일 캐시 무효화 → 테마 변경 즉시 반영. 운영에서는 제거해야 합니다.
    command:
      - start
      - --http-enabled=true
      - --hostname-strict=false # 개발/운영 초기용: 호스트 검증 OFF
      - --spi-theme-static-max-age=-1
      - --spi-theme-cache-themes=false
      - --spi-theme-cache-templates=false

    # 로컬 컴퓨터(Host)와 컨테이너(Guest)의 포트를 연결합니다.
    ports:
      - "8080:8080"
    
    # keycloak 페이지들 테마 수정을 위한 폴더 추가 (docker-compose down 후 up -d 로 재시작 필요)
    volumes:
     - ./keycloak-themes:/opt/keycloak/themes

  keycloak-db:
    image: postgres:14.12
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: secret
    volumes:
      - keycloak-db-data:/var/lib/postgresql/data  # DB 데이터 영속화

volumes:
  keycloak-db-data:
